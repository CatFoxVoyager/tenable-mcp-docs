# AGENTS.md

This document helps future agents work effectively in this repository.

## Project Overview

**tenable-docs-mcp** is a Model Context Protocol (MCP) server for retrieving Tenable documentation. It serves as an interface between an LLM and the Tenable Developer documentation site (https://developer.tenable.com/).

**Purpose**: Enable AI assistants to retrieve and process technical documentation to help users generate scripts and understand Tenable APIs.

**IMPORTANT**: This server is for documentation retrieval ONLY. It does NOT manage API keys, authenticate to Tenable APIs, or access account data.

## Tech Stack

- **Language**: TypeScript
- **Runtime**: Node.js 18+
- **Framework**: @modelcontextprotocol/sdk
- **Dependencies**:
  - axios: HTTP requests
  - cheerio: HTML parsing/cleaning
  - turndown: HTML to Markdown conversion

## Build and Development Commands

```bash
# Install dependencies
npm install

# Build TypeScript to JavaScript
npm run build

# Start the MCP server
npm start

# Build and start in one command
npm run dev

# Watch mode for development
npm run watch
```

## Project Structure

```
tenable-mcp-docs/
├── src/
│   ├── index.ts           # Main MCP server entry point
│   ├── tools/
│   │   ├── search.ts      # Search tool implementation
│   │   └── read.ts        # Read page tool implementation
│   ├── utils/
│   │   ├── scraper.ts     # HTML scraping, cleaning utilities
│   │   ├── converter.ts   # HTML to Markdown conversion
│   │   ├── indexer.ts     # Documentation indexer (NEW)
│   │   └── cache.ts      # LRU cache implementation (NEW)
│   └── types.ts           # All TypeScript type definitions
├── dist/                  # Compiled JavaScript (generated by build)
├── package.json
├── tsconfig.json
├── README.md
└── AGENTS.md
```

## Key Concepts

### MCP Tools

The server exposes two MCP tools:

1. **search_docs**: Search Tenable documentation for relevant pages
   - Input: `query` (string) - Search terms
   - Output: Array of `{url, title, description}` objects

2. **read_page**: Download a page and convert to Markdown
   - Input: `url` (string) - Tenable documentation URL
   - Output: `{url, title, content, wordCount}` object

### Error Handling

Custom error classes in `src/types.ts`:
- `ValidationError`: Invalid input parameters
- `NetworkError`: HTTP request failures
- `ParseError`: HTML/JSON parsing failures
- `ScrapingError`: Content scraping/cleaning failures
- `ConversionError`: HTML to Markdown conversion failures
- `SearchError`: Search functionality failures

All tools return structured error responses with `code`, `message`, and `details`.

### Code Patterns

- **Type Safety**: Full TypeScript typing everywhere. Import types from `src/types.ts`
- **Async Functions**: All async functions use try-catch with proper error handling
- **Validation**: Input parameters validated before processing
- **URL Validation**: Only allows URLs from `developer.tenable.com` and `tenable.com`
- **Code Block Preservation**: Code blocks extracted before cleaning and restored after

## Important Gotchas

1. **Real Search Index**: The search tool uses a pre-built index scraped from Tenable documentation at server startup. It contains 629+ indexed entries and returns actual, working URLs. No more 404s from generated URLs.

2. **Cache Performance**: The `read_page` tool uses an LRU cache (100 entries max, 24h TTL). Cache hits return in ~5ms vs ~2-4s for fresh downloads. Expect 90-95% cache hit rate for typical usage.

3. **404 Fallbacks**: When a page returns 404, the tool provides helpful suggestions including a link to the main API reference, navigation suggestions, and a list of common endpoints.

4. **Index Initialization**: Server indexes 629+ entries at startup (takes 5-10 seconds). This is a one-time operation at server start. Check stderr logs for indexing progress.

5. **Stdio Transport**: Server uses stdio transport for MCP communication. It's meant to be run as a subprocess by MCP clients like Claude Desktop.

6. **Domain Restriction**: The `read_page` tool only accepts URLs from Tenable documentation domains. This is a security measure.

7. **TypeScript Compilation**: Always run `npm run build` before testing. The server runs from `dist/index.js`, not the source files.

8. **Error Output**: Errors are sent to `stderr` (via `console.error`) for MCP protocol compliance. Startup messages only appear if `DEBUG` environment variable is set.

## Testing the Server

To test the server locally:

```bash
# Build the project
npm run build

# Start the server (it will wait for MCP protocol messages)
npm start
```

**Note**: The server uses stdio transport and doesn't provide an interactive console. It communicates via JSON messages over stdin/stdout as per MCP protocol.

To actually test the tools, you need an MCP client (like Claude Desktop) configured to use this server.

## Integration with Claude Desktop

Add to Claude Desktop config file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`

```json
{
  "mcpServers": {
    "tenable-docs": {
      "command": "node",
      "args": ["D:/code/tenable-mcp-docs/dist/index.js"]
    }
  }
}
```

Replace the path with the actual path to `dist/index.js`.

## Dependencies and Versions

Check `package.json` for current versions:
- @modelcontextprotocol/sdk: ^1.0.4
- axios: ^1.7.9
- cheerio: ^1.0.0-rc.12
- turndown: ^7.2.0

## Code Quality Standards

- **TypeScript Strict Mode**: Enabled in `tsconfig.json`
- **ES2022 Target**: Modern JavaScript features
- **No Unused Variables**: TypeScript flags unused imports/variables
- **JSDoc Comments**: All public functions documented
- **Error First**: All async operations handle errors explicitly

## Troubleshooting Common Issues

### Build Fails with TypeScript Errors

Check for:
- Unused imports
- Type mismatches
- Missing type definitions

Run `npm run build` to see specific errors.

### Server Won't Start

Verify:
- Dependencies installed: `npm install`
- Project built: `npm run build`
- Node.js version: `node --version` (must be 18+)

### Tools Not Appearing in Claude Desktop

1. Verify path in config points to `dist/index.js` (NOT `src/index.ts`)
2. Restart Claude Desktop after config change
3. Check Claude Desktop logs for errors

## Security Considerations

- **URL Whitelisting**: Only Tenable documentation domains allowed
- **No Credential Storage**: Server doesn't handle API keys or secrets
- **Input Validation**: All inputs validated before processing
- **No Code Execution**: Server only reads and converts documentation

## Adding New Features

When adding new tools:

1. Add tool to `src/tools/` directory
2. Implement with TypeScript types from `src/types.ts`
3. Register tool in `src/index.ts` under `ListToolsRequestSchema` handler
4. Add tool handler in `CallToolRequestSchema` handler
5. Use proper error handling with custom error types
6. Test build with `npm run build`

## Documentation Files

- **README.md**: User-facing documentation (installation, usage, examples)
- **AGENTS.md**: This file - for AI agents working on this codebase
- **JSDoc comments**: Inline code documentation

## Testing

Currently, the project doesn't have automated tests. When adding tests:

1. Use a testing framework like Jest or Vitest
2. Test tool logic independently of MCP server
3. Mock HTTP requests for scraper tests
4. Mock HTML content for converter tests
5. Add test script to `package.json`

## Search Implementation Details

The search tool works by:
1. **Indexing at startup**: Server scrapes `developer.tenable.com/reference` and `developer.tenable.com/recipes` pages (takes 5-10s)
2. **Extracting links**: Finds all `<a>` tags with documentation URLs
3. **Building index**: Creates keyword-to-entry map and category-to-entry map
4. **Searching queries**: Matches query keywords against indexed entries
5. **Scoring results**: Calculates relevance scores based on keyword matches
6. **Returning top results**: Returns top 10 most relevant entries

**Index stats** (from v1.0.1):
- 629+ API documentation entries
- 17 recipe entries
- 646 total indexed entries
- All URLs are verified and working
- Keyword-based search with relevance scoring

**Performance**:
- Cached search: ~1-5ms
- Fresh search: ~10-50ms (no network)
- Index rebuild: 5-10 seconds (only at startup)

## Code Block Preservation

The scraper preserves code blocks during HTML cleaning:

1. Extract all `<pre>` and `<code>` elements
2. Replace with placeholders (`__CODE_BLOCK_N__`)
3. Clean the rest of the HTML
4. Restore original code blocks from placeholders

This ensures code examples maintain their syntax and formatting.

## Markdown Conversion

The converter uses Turndown with custom rules:
- Code blocks with language specification
- Inline code
- Tables
- Links with titles
- Images
- Blockquotes
- Horizontal rules

All configured to produce clean, readable Markdown.

## Utility Modules

### Indexer (`src/utils/indexer.ts`)

Documentation indexer that scrapes Tenable documentation at startup:

- **`initializeIndex()`**: Build and populate the search index
- **`search(query)`**: Search indexed documentation by keywords
- **`getAllEntries()`**: Get all indexed entries
- **`getEntriesByCategory(category)`**: Filter entries by category
- **`getCategories()`**: Get all available categories

The indexer:
- Scrapes `developer.tenable.com/reference` (629+ entries)
- Scrapes `developer.tenable.com/recipes` (17+ entries)
- Removes duplicates based on URL
- Builds keyword map for fast search
- Builds category map for filtering
- Returns results sorted by relevance

### Cache (`src/utils/cache.ts`)

LRU cache implementation for performance:

- **`LRUCache`**: Generic LRU cache with TTL
  - `get(key)`: Retrieve cached value or undefined if not found/expired
  - `set(key, value)`: Store value in cache (evicts LRU if full)
  - `delete(key)`: Remove specific entry
  - `clear()`: Remove all entries
  - `has(key)`: Check if key exists and not expired
  - `getStats()`: Get cache statistics
  - `cleanup()`: Remove expired entries

- **`createCacheKey(url, params)`**: Create cache key from URL and parameters

Usage in `read_page`:
- Cache key: URL string
- Max entries: 100
- TTL: 24 hours (86,400,000 ms)
- Eviction: Least recently used (LRU)
- Hit rate: Expected 90-95%
